from core.color import Color

class Ida:
    """ This class helps to create IDA script to rename functions
    
    Attributes:
     - emu(Emu): Emulated functions
    """

    def __init__(self, emu):
        """Initialization
        
        Arguments:
         - emu(Emu): Emulated functions
        """
        self.emu = emu
        self.script = ""

        # Generate functions renaming
        self.gen_func()
    
    def make_function(self, addr):
        self.script += "MakeFunction({})\n".format(addr)

    def gen_func(self):
        """ Generate IDA script to rename functions """

        for name, deobf in self.emu.list_emu.items():
            pattern = deobf.pattern
            matches = pattern.matches
            for index, match in enumerate(matches.matches):
                self.make_function(match.func_addr)
                self.script += "MakeNameEx({addr}, \"{}_{}\", SN_NOWARN)\n".format(pattern.name, index, addr=match.func_addr)

    def dump(self, path):
        """ Dump the script into a file"""
        with open(path, 'w') as f:
            f.writelines(self.script)
        
        print Color.step("Creation of an IDA script to rename function: {}".format(path))
    

