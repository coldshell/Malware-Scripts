Nymaim deobfuscation
===

This tool helps to deobfuscate nymaim samples.

To deobfuscate we use `miasm` for the emulation and `grap` to match graph patterns. 

# Usage

Patch nymaim and generate an IDA script to rename fonctions:

```
 ./nymaim.py --ida /tmp/nymaim_unpack_2018-03-28.bin

[+] Searching for the pattern push_reg
[i] The graph push_reg was found 1 time(s)
[+] Emulating each call to push_reg
[+] Patching each call to push_reg (can take a will)
[+] Searching for the pattern detour_call
[i] The graph detour_call was found 34 time(s)
[e] No XREFS to the function 0x429537 was found
[+] Emulating each call to detour_call
[+] Patching each call to detour_call (can take a will)
[+] Searching for the pattern detour_jmp
[i] The graph detour_jmp was found 32 time(s)
[e] No XREFS to the function 0x402AC2 was found
[e] No XREFS to the function 0x404A23 was found
[e] No XREFS to the function 0x404EAB was found
[e] No XREFS to the function 0x406A90 was found
[e] No XREFS to the function 0x4081B3 was found
[e] No XREFS to the function 0x40DF3D was found
[e] No XREFS to the function 0x41148D was found
[e] No XREFS to the function 0x419F2C was found
[e] No XREFS to the function 0x41A5B4 was found
[e] No XREFS to the function 0x41FB49 was found
[e] No XREFS to the function 0x42247A was found
[e] No XREFS to the function 0x423A38 was found
[e] No XREFS to the function 0x42477F was found
[e] No XREFS to the function 0x4278C1 was found
[e] No XREFS to the function 0x42914B was found
[e] No XREFS to the function 0x42BFFF was found
[e] No XREFS to the function 0x42F385 was found
[e] No XREFS to the function 0x43212F was found
[+] Emulating each call to detour_jmp
[+] Patching each call to detour_jmp (can take a will)
[+] Creation of an IDA script to rename function: /tmp/nymaim_unpack_2018-03-28.bin_ida.py
[+] Patched nymaim available: /tmp/nymaim_unpack_2018-03-28.bin.clean
```

The generated IDA script look like this:

```
MakeFunction(4214618)
MakeNameEx(4214618, "detour_jmp_0", SN_NOWARN)
MakeFunction(4226729)
MakeNameEx(4226729, "detour_jmp_1", SN_NOWARN)
MakeFunction(4229427)
MakeNameEx(4229427, "detour_jmp_2", SN_NOWARN)
MakeFunction(4261327)
MakeNameEx(4261327, "detour_jmp_3", SN_NOWARN)
MakeFunction(4270551)
MakeNameEx(4270551, "detour_jmp_4", SN_NOWARN)
MakeFunction(4327584)
MakeNameEx(4327584, "detour_jmp_5", SN_NOWARN)
MakeFunction(4327617)
MakeNameEx(4327617, "detour_jmp_6", SN_NOWARN)
MakeFunction(4356652)
MakeNameEx(4356652, "detour_jmp_7", SN_NOWARN)
MakeFunction(4363982)
MakeNameEx(4363982, "detour_jmp_8", SN_NOWARN)
MakeFunction(4370138)
MakeNameEx(4370138, "detour_jmp_9", SN_NOWARN)
MakeFunction(4370701)
MakeNameEx(4370701, "detour_jmp_10", SN_NOWARN)
MakeFunction(4387112)
MakeNameEx(4387112, "detour_jmp_11", SN_NOWARN)
MakeFunction(4389759)
MakeNameEx(4389759, "detour_jmp_12", SN_NOWARN)
MakeFunction(4410336)
MakeNameEx(4410336, "detour_jmp_13", SN_NOWARN)
MakeFunction(4363511)
MakeNameEx(4363511, "push_reg_0", SN_NOWARN)
MakeFunction(4201630)
MakeNameEx(4201630, "detour_call_0", SN_NOWARN)
MakeFunction(4201754)
MakeNameEx(4201754, "detour_call_1", SN_NOWARN)
MakeFunction(4211030)
MakeNameEx(4211030, "detour_call_2", SN_NOWARN)
MakeFunction(4235314)
MakeNameEx(4235314, "detour_call_3", SN_NOWARN)
MakeFunction(4246535)
MakeNameEx(4246535, "detour_call_4", SN_NOWARN)
MakeFunction(4252137)
MakeNameEx(4252137, "detour_call_5", SN_NOWARN)
MakeFunction(4263623)
MakeNameEx(4263623, "detour_call_6", SN_NOWARN)
MakeFunction(4273611)
MakeNameEx(4273611, "detour_call_7", SN_NOWARN)
MakeFunction(4273660)
MakeNameEx(4273660, "detour_call_8", SN_NOWARN)
MakeFunction(4284380)
MakeNameEx(4284380, "detour_call_9", SN_NOWARN)
MakeFunction(4289573)
MakeNameEx(4289573, "detour_call_10", SN_NOWARN)
MakeFunction(4290747)
MakeNameEx(4290747, "detour_call_11", SN_NOWARN)
MakeFunction(4297747)
MakeNameEx(4297747, "detour_call_12", SN_NOWARN)
MakeFunction(4308629)
MakeNameEx(4308629, "detour_call_13", SN_NOWARN)
MakeFunction(4308874)
MakeNameEx(4308874, "detour_call_14", SN_NOWARN)
MakeFunction(4309082)
MakeNameEx(4309082, "detour_call_15", SN_NOWARN)
MakeFunction(4309710)
MakeNameEx(4309710, "detour_call_16", SN_NOWARN)
MakeFunction(4311489)
MakeNameEx(4311489, "detour_call_17", SN_NOWARN)
MakeFunction(4315321)
MakeNameEx(4315321, "detour_call_18", SN_NOWARN)
MakeFunction(4316629)
MakeNameEx(4316629, "detour_call_19", SN_NOWARN)
MakeFunction(4351100)
MakeNameEx(4351100, "detour_call_20", SN_NOWARN)
MakeFunction(4353103)
MakeNameEx(4353103, "detour_call_21", SN_NOWARN)
MakeFunction(4358747)
MakeNameEx(4358747, "detour_call_22", SN_NOWARN)
MakeFunction(4361221)
MakeNameEx(4361221, "detour_call_23", SN_NOWARN)
MakeFunction(4371830)
MakeNameEx(4371830, "detour_call_24", SN_NOWARN)
MakeFunction(4379826)
MakeNameEx(4379826, "detour_call_25", SN_NOWARN)
MakeFunction(4380017)
MakeNameEx(4380017, "detour_call_26", SN_NOWARN)
MakeFunction(4388557)
MakeNameEx(4388557, "detour_call_27", SN_NOWARN)
MakeFunction(4396147)
MakeNameEx(4396147, "detour_call_28", SN_NOWARN)
MakeFunction(4398196)
MakeNameEx(4398196, "detour_call_29", SN_NOWARN)
MakeFunction(4409110)
MakeNameEx(4409110, "detour_call_30", SN_NOWARN)
MakeFunction(4411024)
MakeNameEx(4411024, "detour_call_31", SN_NOWARN)
MakeFunction(4412213)
MakeNameEx(4412213, "detour_call_32", SN_NOWARN)
```

Before/After:

![detour call](./img/nymaim-detour_call.png)

![push reg](./img/nymaim-push-reg.png)

# Requirements

You will need [grap](https://github.com/AirbusCyber/grap) and [miasm](https://github.com/cea-sec/miasm).
For the others dependencies see the `requierments.txt`.
